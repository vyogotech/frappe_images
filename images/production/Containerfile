FROM frappe/erpnext:version-15 AS erpnext

# Switch to root to perform system changes
USER root

# 1. OpenShift Compatibility:
# - Install 'wait-for-it' for orchestrating startup
# - Install 'nginx' and 'gettext-base' (for envsubst) as these are needed for frontend mode
# - Fix permissions for arbitrary UIDs (Group 0)
RUN \
    # Nginx config for non-root
    rm -fr /etc/nginx/sites-enabled/default && \
    sed -i '/user www-data/d' /etc/nginx/nginx.conf && \
    sed -i 's/listen 80 default_server/listen 8080 default_server/' /etc/nginx/sites-available/default || true && \
    ln -sf /dev/stdout /var/log/nginx/access.log && ln -sf /dev/stderr /var/log/nginx/error.log && \
    touch /run/nginx.pid && \
    chown -R frappe:root /etc/nginx /var/log/nginx /var/lib/nginx /run && \
    chmod -R g=u /etc/nginx /var/log/nginx /var/lib/nginx /run

# 2. Copy Helper Scripts
# We need our custom entrypoints for proper initialization
COPY resources/nginx-template.conf /templates/nginx/frappe.conf.template
COPY resources/nginx-entrypoint.sh /usr/local/bin/nginx-entrypoint.sh
COPY resources/entrypoint.sh /usr/local/bin/entrypoint.sh

# 3. Permission Fixes
# OpenShift runs as random UID but GID 0.
# We must ensure GID 0 can write to these directories.
RUN chmod +x /usr/local/bin/nginx-entrypoint.sh /usr/local/bin/entrypoint.sh && \
    # Move assets to cache and create symlink target if they exist (base image might have them)
    # The base image has sites/assets. We want to move them to assets_cache.
    # Check if sites/assets exists before moving
    if [ -d "/home/frappe/frappe-bench/sites/assets" ]; then \
        mkdir -p /home/frappe/assets_cache; \
        mv /home/frappe/frappe-bench/sites/assets/* /home/frappe/assets_cache/ || true; \
        rm -rf /home/frappe/frappe-bench/sites/assets; \
    fi && \
    mkdir -p /home/frappe/frappe-bench/sites/assets && \
    mkdir -p /home/frappe/assets_cache && \
    # recursive chown/chmod for the frappe-bench directory
    chown -R frappe:root /home/frappe/frappe-bench /home/frappe/assets_cache && \
    chmod -R g=u /home/frappe/frappe-bench /home/frappe/assets_cache && \
    # Allow writing to /etc/passwd for the entrypoint user mapping trick
    chmod g=u /etc/passwd

# Switch back to frappe user (1000)
# OpenShift will override this UID, but we leave it as default for local docker
USER 1000

# Set the entrypoint
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["/home/frappe/frappe-bench/env/bin/gunicorn", "--chdir=/home/frappe/frappe-bench/sites", "--bind=0.0.0.0:8000", "--threads=4", "--workers=2", "--worker-class=gthread", "--worker-tmp-dir=/dev/shm", "--timeout=120", "--preload", "frappe.app:application"]
